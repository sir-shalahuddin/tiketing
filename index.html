<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Helpdesk - Full Feature (Edit & WA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #F4F5F7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Kanban Styles */
        .kanban-board { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; height: calc(100vh - 180px); }
        .kanban-col { background-color: #EBECF0; border-radius: 8px; min-width: 300px; width: 300px; display: flex; flex-direction: column; }
        .kanban-col-header { padding: 12px 16px; font-weight: 600; font-size: 13px; text-transform: uppercase; color: #5E6C84; }
        .kanban-cards { flex: 1; padding: 0 8px 12px 8px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; min-height: 100px; }
        .kanban-cards.drag-over { background-color: #DFE1E6; border: 2px dashed #4C9AFF; }
        .jira-card { background: white; border-radius: 4px; padding: 10px; box-shadow: 0 1px 0 rgba(9, 30, 66, 0.25); border-left: 4px solid transparent; cursor: grab; position: relative;}
        .jira-card:active { cursor: grabbing; transform: scale(1.02); }
        
        /* Table Styles */
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status-open { background-color: #E2E8F0; color: #475569; }
        .status-assigned { background-color: #FEF3C7; color: #92400E; }
        .status-inprogress { background-color: #DBEAFE; color: #1E40AF; }
        .status-resolved { background-color: #D1FAE5; color: #065F46; }

        .border-open { border-left-color: #9CA3AF; }
        .border-assigned { border-left-color: #F59E0B; }
        .border-progress { border-left-color: #3B82F6; }
        .border-resolved { border-left-color: #10B981; }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <div id="loginScreen" class="absolute inset-0 bg-[#F4F5F7] z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
            <h1 class="text-2xl font-bold text-slate-800 text-center mb-6">Service Desk Login</h1>
            <div class="space-y-3">
                <button onclick="login('user1')" class="w-full p-3 bg-white hover:bg-slate-50 border rounded-lg flex items-center gap-3 transition">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">U</div>
                    <div class="text-left"><p class="font-bold text-sm">End User (Requester)</p></div>
                </button>
                <button onclick="login('admin1')" class="w-full p-3 bg-white hover:bg-slate-50 border rounded-lg flex items-center gap-3 transition">
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold">A</div>
                    <div class="text-left"><p class="font-bold text-sm">Administrator</p></div>
                </button>
                <button onclick="login('tech1')" class="w-full p-3 bg-white hover:bg-slate-50 border rounded-lg flex items-center gap-3 transition">
                    <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold">T</div>
                    <div class="text-left"><p class="font-bold text-sm">Technical Support</p></div>
                </button>
            </div>
        </div>
    </div>

    <div id="dashboardScreen" class="hidden flex-1 flex flex-col h-full">
        <header class="bg-white border-b px-6 py-3 flex justify-between items-center z-10">
            <div class="flex items-center gap-6">
                <h1 class="font-bold text-xl text-slate-800"><i class="fa-solid fa-square-kanban text-blue-600 mr-2"></i>Service Desk</h1>
                
                <div class="flex bg-slate-100 p-1 rounded-lg border">
                    <button onclick="switchView('kanban')" id="btnViewKanban" class="px-3 py-1.5 text-xs font-bold rounded shadow-sm bg-white text-blue-600 transition">
                        <i class="fa-solid fa-table-columns mr-1"></i> Kanban
                    </button>
                    <button onclick="switchView('table')" id="btnViewTable" class="px-3 py-1.5 text-xs font-bold rounded text-slate-500 hover:text-slate-700 transition">
                        <i class="fa-solid fa-list mr-1"></i> Table
                    </button>
                </div>

                <button id="btnCreateTicket" onclick="toggleCreateModal(true)" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm font-medium transition shadow-sm">
                    + New Ticket
                </button>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right border-r pr-4">
                    <p id="userNameDisplay" class="text-sm font-bold text-slate-800">-</p>
                    <p id="userRoleDisplay" class="text-xs text-slate-500">-</p>
                </div>
                <button onclick="location.reload()" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-right-from-bracket text-xl"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-hidden p-6">
            <div id="viewKanban" class="block h-full">
                <div class="kanban-board">
                    <div class="kanban-col">
                        <div class="kanban-col-header">Open <span id="count-Open" class="ml-1 bg-slate-300 px-2 rounded-full text-xs text-slate-700">0</span></div>
                        <div class="kanban-cards" id="col-Open" ondrop="drop(event, 'Open')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)"></div>
                    </div>
                    <div class="kanban-col">
                        <div class="kanban-col-header">Assigned <span id="count-Assigned" class="ml-1 bg-yellow-200 px-2 rounded-full text-xs text-yellow-800">0</span></div>
                        <div class="kanban-cards" id="col-Assigned" ondrop="drop(event, 'Assigned')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)"></div>
                    </div>
                    <div class="kanban-col">
                        <div class="kanban-col-header">In Progress <span id="count-InProgress" class="ml-1 bg-blue-200 px-2 rounded-full text-xs text-blue-800">0</span></div>
                        <div class="kanban-cards" id="col-InProgress" ondrop="drop(event, 'In Progress')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)"></div>
                    </div>
                    <div class="kanban-col">
                        <div class="kanban-col-header">Resolved <span id="count-Resolved" class="ml-1 bg-green-200 px-2 rounded-full text-xs text-green-800">0</span></div>
                        <div class="kanban-cards" id="col-Resolved" ondrop="drop(event, 'Resolved')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)"></div>
                    </div>
                </div>
            </div>

            <div id="viewTable" class="hidden h-full overflow-auto">
                <div class="bg-white rounded-lg shadow border border-slate-200 overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Ticket ID</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Issue</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Requester</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Assigned To</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ticketTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="createTicketModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="font-bold text-lg">New Ticket</h2>
                <button onclick="toggleCreateModal(false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="ticketForm" class="p-4 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Issue Summary</label>
                    <input type="text" id="ticketTitle" required class="w-full border rounded p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Brief title of the issue...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                    <textarea id="ticketDesc" required rows="4" class="w-full border rounded p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Please provide detailed information..."></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="toggleCreateModal(false)" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded shadow">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editTicketModal" class="hidden fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="font-bold text-lg">Edit Ticket</h2>
                <button onclick="toggleEditModal(false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="editForm" class="p-4 space-y-4">
                <input type="hidden" id="eTicketId">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Issue Summary</label>
                    <input type="text" id="eTicketTitle" required class="w-full border rounded p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                    <textarea id="eTicketDesc" required rows="4" class="w-full border rounded p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="toggleEditModal(false)" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded shadow">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewTicketModal" class="hidden fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full">
            <div class="p-4 border-b flex justify-between items-start">
                <div class="pr-8">
                    <span id="vTicketId" class="text-xs font-mono font-bold text-slate-400 block mb-1"></span>
                    <h2 id="vTicketTitle" class="font-bold text-xl text-slate-800 leading-tight"></h2>
                </div>
                <button onclick="toggleViewModal(false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-5 space-y-4">
                <div class="flex gap-3 mb-2">
                    <div class="flex-1 bg-slate-50 p-3 rounded border">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Status</p>
                        <span id="vTicketStatus" class="status-badge block w-max mt-1"></span>
                    </div>
                    <div class="flex-1 bg-slate-50 p-3 rounded border">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Requester</p>
                        <div class="flex items-center justify-between mt-1">
                            <p id="vTicketUser" class="text-sm font-semibold text-slate-700 truncate"></p>
                            <button id="btnWaUser" class="text-green-500 hover:text-green-600 text-lg ml-2" title="Contact via WhatsApp">
                                <i class="fa-brands fa-whatsapp"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 bg-slate-50 p-3 rounded border">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Assignee</p>
                        <p id="vTicketTech" class="text-sm font-semibold text-slate-700 mt-1"></p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Description</label>
                    <div id="vTicketDesc" class="bg-slate-50 border p-3 rounded text-sm text-slate-700 whitespace-pre-wrap min-h-[100px]"></div>
                </div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex justify-end gap-2 rounded-b-lg">
                <button id="btnEditTicket" class="hidden px-4 py-2 text-sm bg-amber-500 hover:bg-amber-600 text-white font-medium rounded shadow">Edit Ticket</button>
                <button onclick="toggleViewModal(false)" class="px-4 py-2 text-sm bg-white border font-medium text-slate-600 hover:bg-slate-50 rounded">Close</button>
            </div>
        </div>
    </div>

    <script>
        const state = {
            currentUser: null,
            currentView: 'kanban',
            users: [
                // Ditambahkan field 'phone' untuk fungsi WA
                { id: "u1", username: "user1", role: "User", name: "John Doe", phone: "6281234567890" },
                { id: "a1", username: "admin1", role: "Admin", name: "System Admin", phone: "6289876543210" },
                { id: "t1", username: "tech1", role: "Tech Support", name: "Support Agent A", phone: "6285555555555" }
            ],
            tickets: [
                { id: "TCK-1001", title: "Cannot access network drive", description: "I am trying to map the Z: drive but it says network path not found. Please help, I need files for the meeting.", status: "Open", userId: "u1", techId: null },
                { id: "TCK-1002", title: "Laptop keyboard replacement", description: "The 'Enter' and 'Space' keys are completely stuck. Spilled some coffee on it yesterday.", status: "Assigned", userId: "u1", techId: "t1" },
                { id: "TCK-1003", title: "VPN connection dropping frequently", description: "Since the update yesterday, my VPN disconnects every 15 minutes. It's disrupting my SSH sessions.", status: "In Progress", userId: "u1", techId: "t1" }
            ]
        };

        function login(username) {
            state.currentUser = state.users.find(u => u.username === username);
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = state.currentUser.name;
            document.getElementById('userRoleDisplay').innerText = state.currentUser.role;

            if(state.currentUser.role === 'User' || state.currentUser.role === 'Admin') {
                document.getElementById('btnCreateTicket').classList.remove('hidden');
            }

            renderAll();
        }

        function switchView(viewType) {
            state.currentView = viewType;
            const btnK = document.getElementById('btnViewKanban');
            const btnT = document.getElementById('btnViewTable');
            const viewK = document.getElementById('viewKanban');
            const viewT = document.getElementById('viewTable');

            if (viewType === 'kanban') {
                viewK.classList.remove('hidden');
                viewT.classList.add('hidden');
                btnK.className = "px-3 py-1.5 text-xs font-bold rounded shadow-sm bg-white text-blue-600 transition";
                btnT.className = "px-3 py-1.5 text-xs font-bold rounded text-slate-500 hover:text-slate-700 transition";
            } else {
                viewK.classList.add('hidden');
                viewT.classList.remove('hidden');
                btnT.className = "px-3 py-1.5 text-xs font-bold rounded shadow-sm bg-white text-blue-600 transition";
                btnK.className = "px-3 py-1.5 text-xs font-bold rounded text-slate-500 hover:text-slate-700 transition";
            }
        }

        // --- WHATSAPP FUNCTION ---
        function openWhatsApp(phone, ticketId, ticketTitle) {
            if (!phone) {
                alert("Nomor telepon pengguna tidak tersedia.");
                return;
            }
            // Format Pesan
            const text = encodeURIComponent(`Halo, saya menghubungi terkait tiket Helpdesk *#${ticketId}* - *${ticketTitle}*.`);
            const url = `https://wa.me/${phone}?text=${text}`;
            window.open(url, '_blank');
        }

        // --- MODAL CONTROLS ---
        function toggleCreateModal(show) {
            document.getElementById('createTicketModal').classList.toggle('hidden', !show);
            if(show) document.getElementById('ticketTitle').focus();
        }

        function toggleEditModal(show, ticketId = null) {
            const modal = document.getElementById('editTicketModal');
            if(show && ticketId) {
                const ticket = state.tickets.find(t => t.id === ticketId);
                document.getElementById('eTicketId').value = ticket.id;
                document.getElementById('eTicketTitle').value = ticket.title;
                document.getElementById('eTicketDesc').value = ticket.description;
                toggleViewModal(false); // Tutup view detail saat buka edit
            }
            modal.classList.toggle('hidden', !show);
        }

        function toggleViewModal(show) {
            document.getElementById('viewTicketModal').classList.toggle('hidden', !show);
        }

        function viewTicketDetails(ticketId) {
            const ticket = state.tickets.find(t => t.id === ticketId);
            if(!ticket) return;

            const requester = state.users.find(u => u.id === ticket.userId);
            const tech = ticket.techId ? state.users.find(u => u.id === ticket.techId).name : 'Not Assigned';
            const statusClass = `status-${ticket.status.toLowerCase().replace(/\s/g, '')}`;

            document.getElementById('vTicketId').innerText = ticket.id;
            document.getElementById('vTicketTitle').innerText = ticket.title;
            document.getElementById('vTicketDesc').innerText = ticket.description;
            document.getElementById('vTicketUser').innerText = requester.name;
            document.getElementById('vTicketTech').innerText = tech;
            
            // Set WhatsApp Action
            const btnWa = document.getElementById('btnWaUser');
            btnWa.onclick = () => openWhatsApp(requester.phone, ticket.id, ticket.title);

            // Set Badge
            const badge = document.getElementById('vTicketStatus');
            badge.className = `status-badge ${statusClass} block w-max mt-1`;
            badge.innerText = ticket.status;

            // Logic Edit Button (Hanya Admin atau Pembuat Tiket yang bisa edit)
            const btnEdit = document.getElementById('btnEditTicket');
            if(state.currentUser.role === 'Admin' || state.currentUser.id === ticket.userId) {
                btnEdit.classList.remove('hidden');
                btnEdit.onclick = () => toggleEditModal(true, ticket.id);
            } else {
                btnEdit.classList.add('hidden');
            }

            toggleViewModal(true);
        }

        // --- SUBMIT NEW TICKET ---
        document.getElementById('ticketForm').onsubmit = function(e) {
            e.preventDefault();
            const newId = "TCK-" + (1000 + state.tickets.length + 1);
            state.tickets.push({
                id: newId,
                title: document.getElementById('ticketTitle').value,
                description: document.getElementById('ticketDesc').value,
                status: "Open",
                userId: state.currentUser.id,
                techId: null
            });
            this.reset();
            toggleCreateModal(false);
            renderAll();
        };

        // --- SUBMIT EDIT TICKET ---
        document.getElementById('editForm').onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('eTicketId').value;
            const ticket = state.tickets.find(t => t.id === id);
            
            if(ticket) {
                ticket.title = document.getElementById('eTicketTitle').value;
                ticket.description = document.getElementById('eTicketDesc').value;
                renderAll();
                
                // Opsional: Buka kembali view modal dengan data baru
                toggleEditModal(false);
                viewTicketDetails(id);
            }
        };

        function getSafeId(status) { return status.replace(/\s+/g, ''); }

        function renderAll() {
            renderKanban();
            renderTable();
        }

        function renderKanban() {
            ['Open', 'Assigned', 'In Progress', 'Resolved'].forEach(status => {
                const safeId = getSafeId(status);
                document.getElementById(`col-${safeId}`).innerHTML = '';
                document.getElementById(`count-${safeId}`).innerText = '0';
            });

            state.tickets.forEach(t => {
                let bColor = t.status === 'Open' ? 'border-open' : (t.status === 'Assigned' ? 'border-assigned' : (t.status === 'In Progress' ? 'border-progress' : 'border-resolved'));
                let techName = t.techId ? state.users.find(u => u.id === t.techId).name : 'Unassigned';

                const cardHTML = `
                    <div id="${t.id}" class="jira-card ${bColor}" draggable="true" ondragstart="dragStart(event)">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-bold text-slate-400">${t.id}</span>
                            <div class="w-5 h-5 rounded bg-slate-100 flex items-center justify-center text-[9px] font-bold text-slate-600" title="${techName}">
                                ${techName !== 'Unassigned' ? techName.charAt(0) : '?'}
                            </div>
                        </div>
                        <h4 class="text-sm text-slate-700 leading-tight hover:text-blue-600 cursor-pointer" onclick="viewTicketDetails('${t.id}')">${t.title}</h4>
                    </div>
                `;
                
                const colContainer = document.getElementById(`col-${getSafeId(t.status)}`);
                if(colContainer) {
                    colContainer.innerHTML += cardHTML;
                    const countEl = document.getElementById(`count-${getSafeId(t.status)}`);
                    countEl.innerText = parseInt(countEl.innerText) + 1;
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('ticketTableBody');
            tbody.innerHTML = '';

            state.tickets.forEach(t => {
                const requester = state.users.find(u => u.id === t.userId).name;
                const tech = t.techId ? state.users.find(u => u.id === t.techId).name : 'Not Assigned';
                const statusClass = `status-${t.status.toLowerCase().replace(/\s/g, '')}`;
                
                const canEdit = state.currentUser.role === 'Admin' || (state.currentUser.role === 'Tech Support' && t.techId === state.currentUser.id);

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-xs font-mono font-bold text-gray-500">${t.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${t.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge ${statusClass}">${t.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${requester}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tech}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end gap-2 items-center h-[53px]">
                            <button onclick="viewTicketDetails('${t.id}')" class="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded transition text-xs">View</button>
                            ${canEdit ? `
                                <select onchange="updateStatusFromTable('${t.id}', this.value)" class="border rounded text-xs p-1 outline-none focus:ring-1 focus:ring-blue-500 h-[26px]">
                                    <option value="Open" ${t.status === 'Open' ? 'selected' : ''}>Open</option>
                                    <option value="Assigned" ${t.status === 'Assigned' ? 'selected' : ''}>Assigned</option>
                                    <option value="In Progress" ${t.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Resolved" ${t.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                                </select>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
        }

        function updateStatusFromTable(ticketId, newStatus) {
            const ticket = state.tickets.find(t => t.id === ticketId);
            if (ticket) {
                ticket.status = newStatus;
                renderAll(); 
            }
        }

        // --- DRAG & DROP LOGIC ---
        function dragStart(ev) {
            const card = ev.target.closest('.jira-card');
            const ticket = state.tickets.find(x => x.id === card.id);
            const role = state.currentUser.role;

            if (role === 'User') {
                alert("❌ Akses Dibatasi: User hanya bisa membuat tiket.");
                ev.preventDefault();
                return;
            }
            if (role === 'Tech Support' && ticket.techId !== state.currentUser.id) {
                alert(`❌ Akses Ditolak: Tiket ini belum di-assign ke Anda.`);
                ev.preventDefault();
                return;
            }

            ev.dataTransfer.setData("ticketId", card.id);
        }

        function allowDrop(ev) {
            ev.preventDefault();
            const col = ev.target.closest('.kanban-cards');
            if(col) col.classList.add('drag-over');
        }

        function dragLeave(ev) {
            const col = ev.target.closest('.kanban-cards');
            if(col) col.classList.remove('drag-over');
        }

        function drop(ev, newStatus) {
            ev.preventDefault();
            document.querySelectorAll('.kanban-cards').forEach(c => c.classList.remove('drag-over'));
            const ticketId = ev.dataTransfer.getData("ticketId");
            const ticket = state.tickets.find(x => x.id === ticketId);
            
            if(ticket && ticket.status !== newStatus) {
                ticket.status = newStatus;
                renderAll();
            }
        }
    </script>
</body>
</html>